document.addEventListener('DOMContentLoaded', function() {
  // 1. Check if required DOM elements exist
  const timelineList = document.getElementById('timeline-list');
  const addTimelineBtn = document.getElementById('add-timeline-btn');
  const timelineModal = document.getElementById('timeline-modal');
  const closeModal = document.getElementById('close-modal');
  const cancelModal = document.getElementById('cancel-modal');
  const timelineForm = document.getElementById('timeline-form');
  const logoutBtn = document.getElementById('logout-btn');
  
  if (!timelineList || !addTimelineBtn || !timelineModal || !timelineForm) {
    console.error('Critical DOM elements missing for admin dashboard');
    return;
  }

  // 2. Initialize with error handling
  try {
    initializeDashboard();
  } catch (error) {
    console.error('Initialization error:', error);
    showNotification('System initialization failed. Please refresh the page.', 'error');
  }

  function initializeDashboard() {
    // 3. Verify Supabase config is loaded
    if (!window.supabaseConfig) {
      throw new Error('Supabase configuration not loaded');
    }

    // 4. Verify Supabase library is available
    if (typeof supabase === 'undefined') {
      throw new Error('Supabase client library not loaded');
    }

    // 5. Create Supabase client
    const supabaseClient = supabase.createClient(
      window.supabaseConfig.supabaseUrl,
      window.supabaseConfig.supabaseKey
    );

    // 6. Check authentication status
    checkAuthStatus(supabaseClient);

    // 7. Load timeline data
    loadTimelineData(supabaseClient);

    // 8. Set up event listeners
    addTimelineBtn.addEventListener('click', () => {
      openModal('add');
    });

    closeModal.addEventListener('click', closeModalHandler);
    cancelModal.addEventListener('click', closeModalHandler);

    timelineForm.addEventListener('submit', (e) => {
      e.preventDefault();
      handleTimelineSubmit(supabaseClient);
    });

    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        supabaseClient.auth.signOut().then(() => {
          window.location.href = '/auth.html';
        });
      });
    }
  }

  async function checkAuthStatus(supabaseClient) {
    try {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      
      if (error) throw error;
      
      if (!session) {
        window.location.href = '/auth.html';
        return;
      }

      // Verify user is admin
      const { data: profile, error: profileError } = await supabaseClient
        .from('profiles')
        .select('role, is_approved, status')
        .eq('id', session.user.id)
        .single();

      if (profileError) throw profileError;
      
      if (profile.role !== 'admin' || !profile.is_approved || profile.status !== 'active') {
        await supabaseClient.auth.signOut();
        window.location.href = '/auth.html';
        return;
      }
    } catch (error) {
      console.error('Auth check error:', error);
      window.location.href = '/auth.html';
    }
  }

  async function loadTimelineData(supabaseClient) {
    try {
      timelineList.innerHTML = `
        <div class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
          <p class="mt-2 text-gray-400">Loading timeline...</p>
        </div>
      `;

      const { data: timelineData, error } = await supabaseClient
        .from('timeline')
        .select('*')
        .order('date', { ascending: false });

      if (error) throw error;

      if (timelineData.length === 0) {
        timelineList.innerHTML = `
          <div class="text-center py-8">
            <iconify-icon icon="mdi:timeline-outline" class="text-4xl text-gray-500"></iconify-icon>
            <p class="mt-2 text-gray-400">No timeline items found.</p>
          </div>
        `;
        return;
      }

      timelineList.innerHTML = '';
      timelineData.forEach(item => {
        const timelineItem = document.createElement('div');
        timelineItem.className = 'timeline-item bg-gray-700 p-4 rounded-lg';
        timelineItem.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold">${item.title}</h3>
              <p class="text-gray-400">${new Date(item.date).toLocaleDateString()}</p>
              <p class="mt-2">${item.description}</p>
              ${item.tags ? `<div class="mt-2 flex flex-wrap gap-2">${item.tags.split(',').map(tag => `<span class="bg-blue-600 text-xs px-2 py-1 rounded">${tag.trim()}</span>`).join('')}</div>` : ''}
            </div>
            <div class="flex space-x-2">
              <button class="edit-btn text-blue-400 hover:text-blue-300" data-id="${item.id}">
                <iconify-icon icon="mdi:pencil"></iconify-icon>
              </button>
              <button class="delete-btn text-red-400 hover:text-red-300" data-id="${item.id}">
                <iconify-icon icon="mdi:delete"></iconify-icon>
              </button>
            </div>
          </div>
        `;
        timelineList.appendChild(timelineItem);
      });

      // Add event listeners to edit and delete buttons
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          openModal('edit', id, timelineData.find(item => item.id == id));
        });
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          deleteTimelineItem(supabaseClient, id);
        });
      });

    } catch (error) {
      console.error('Error loading timeline:', error);
      timelineList.innerHTML = `
        <div class="text-center py-8">
          <iconify-icon icon="mdi:alert-circle-outline" class="text-4xl text-red-500"></iconify-icon>
          <p class="mt-2 text-red-400">Failed to load timeline data.</p>
        </div>
      `;
    }
  }

  function openModal(mode, id = null, data = null) {
    const modalTitle = document.getElementById('modal-title');
    const timelineId = document.getElementById('timeline-id');
    const titleInput = document.getElementById('title');
    const dateInput = document.getElementById('date');
    const descriptionInput = document.getElementById('description');
    const tagsInput = document.getElementById('tags');

    if (mode === 'add') {
      modalTitle.textContent = 'Add Timeline Item';
      timelineId.value = '';
      titleInput.value = '';
      dateInput.value = '';
      descriptionInput.value = '';
      tagsInput.value = '';
    } else if (mode === 'edit' && data) {
      modalTitle.textContent = 'Edit Timeline Item';
      timelineId.value = id;
      titleInput.value = data.title;
      dateInput.value = data.date;
      descriptionInput.value = data.description;
      tagsInput.value = data.tags || '';
    }

    timelineModal.style.display = 'flex';
  }

  function closeModalHandler() {
    timelineModal.style.display = 'none';
  }

  async function handleTimelineSubmit(supabaseClient) {
    const timelineId = document.getElementById('timeline-id').value;
    const title = document.getElementById('title').value;
    const date = document.getElementById('date').value;
    const description = document.getElementById('description').value;
    const tags = document.getElementById('tags').value;
    const submitBtn = timelineForm.querySelector('button[type="submit"]');

    if (!title || !date || !description) {
      showNotification('Please fill in all required fields', 'error');
      return;
    }

    try {
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Saving...';

      let error;
      if (timelineId) {
        // Update existing item
        const { error: updateError } = await supabaseClient
          .from('timeline')
          .update({ title, date, description, tags })
          .eq('id', timelineId);
        error = updateError;
      } else {
        // Insert new item
        const { error: insertError } = await supabaseClient
          .from('timeline')
          .insert([{ title, date, description, tags }]);
        error = insertError;
      }

      if (error) throw error;

      showNotification(`Timeline item ${timelineId ? 'updated' : 'added'} successfully`, 'success');
      closeModalHandler();
      loadTimelineData(supabaseClient);

    } catch (error) {
      console.error('Error saving timeline item:', error);
      showNotification('Failed to save timeline item', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Save';
    }
  }

  async function deleteTimelineItem(supabaseClient, id) {
    if (!confirm('Are you sure you want to delete this timeline item?')) {
      return;
    }

    try {
      const { error } = await supabaseClient
        .from('timeline')
        .delete()
        .eq('id', id);

      if (error) throw error;

      showNotification('Timeline item deleted successfully', 'success');
      loadTimelineData(supabaseClient);

    } catch (error) {
      console.error('Error deleting timeline item:', error);
      showNotification('Failed to delete timeline item', 'error');
    }
  }

  function showNotification(message, type = 'info') {
    // Create notification element if it doesn't exist
    let notification = document.getElementById('global-notification');
    if (!notification) {
      notification = document.createElement('div');
      notification.id = 'global-notification';
      notification.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm';
      document.body.appendChild(notification);
    }

    notification.textContent = message;
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
      type === 'error' ? 'bg-red-600 text-white' :
      type === 'success' ? 'bg-green-600 text-white' :
      'bg-blue-600 text-white'
    }`;

    // Auto hide after 5 seconds
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transition = 'opacity 0.5s';
      setTimeout(() => {
        notification.remove();
      }, 500);
    }, 5000);
  }
});